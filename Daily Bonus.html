<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="FarmToken - Daily Bonus">
  <title>FarmToken - Daily Bonus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow-x: hidden;
      min-height: 100vh;
      background-color: #f9fafb;
    }

    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 2px;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #28a745;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-weight: 500;
    }

    .notification.show {
      opacity: 1;
    }

    .notification.error {
      background: #dc3545;
    }

    .day-card {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .day-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .day-card.claimed {
      opacity: 0.6;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      cursor: default;
    }

    .day-card.claimed:hover {
      transform: none;
    }

    .day-card.current {
      border: 3px solid #28a745;
      box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
      animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
      0%, 100% {
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(40, 167, 69, 0.5);
      }
    }

    .claim-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      transition: all 0.3s ease;
    }

    .claim-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #218838, #1aa179);
      transform: scale(1.05);
    }

    .claim-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .reward-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: linear-gradient(135deg, #ffc107, #ff9800);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
    }

    .streak-counter {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .checkmark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: #28a745;
      opacity: 0.8;
    }

    .ad-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .ad-modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      position: relative;
      max-width: 340px;
      width: 100%;
    }

    .ad-modal-content p {
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }

    .close-ad {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #555;
    }

    .bottom-ad {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }

    @media (max-width: 640px) {
      .notification {
        top: 10px;
        right: 10px;
        padding: 10px 20px;
        font-size: 14px;
      }
      .bottom-ad iframe {
        width: 100%;
        max-width: 320px;
        height: 50px;
      }
    }
  </style>
</head>
<body class="flex flex-col">
  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <div id="notification" class="notification"></div>

  <!-- Ad Modal for Claim -->
  <div id="adModal" class="ad-modal">
    <div class="ad-modal-content">
      <span class="close-ad" onclick="closeAdModal()">&times;</span>
      <p>Thank you for claiming your reward!</p>
      <div id="claimAd">
        <script type="text/javascript">
          atOptions = {
            'key': '78ade24182729fceea8e45203dad915b',
            'format': 'iframe',
            'height': 50,
            'width': 320,
            'params': {}
          };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/78ade24182729fceea8e45203dad915b/invoke.js"></script>
      </div>
    </div>
  </div>

  <header class="flex items-center justify-between px-4 py-3 shadow bg-white sticky top-0 z-10">
    <div class="flex items-center gap-2">
      <img src="Logo.png" alt="FarmToken Logo" class="h-10 w-10 object-contain" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%2328a745%22/></svg>'">
      <h1 class="text-xl sm:text-2xl font-bold text-green-600">Daily Bonus</h1>
    </div>
    <div class="flex items-center gap-2 sm:gap-3">
      <a href="index.html" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
      </a>
    </div>
  </header>

  <section class="p-3 sm:p-4 max-w-4xl mx-auto w-full space-y-4 sm:space-y-6">
    <!-- Streak Info -->
    <div class="streak-counter">
      <div class="text-4xl sm:text-5xl font-bold mb-2" id="streakCount">0</div>
      <div class="text-sm sm:text-base opacity-90">Day Streak</div>
      <div class="text-xs sm:text-sm mt-2 opacity-75">Keep your streak alive by claiming daily!</div>
    </div>

    <!-- Total Earned -->
    <div class="bg-white shadow rounded-xl p-4 sm:p-6 text-center">
      <h3 class="text-gray-600 text-sm sm:text-base mb-2">Total Earned from Daily Bonus</h3>
      <p class="text-3xl sm:text-4xl font-bold text-green-600" id="totalEarned">0.00 FT</p>
    </div>

    <!-- Days Grid -->
    <div class="bg-white shadow rounded-xl p-4 sm:p-6">
      <h2 class="text-lg sm:text-xl font-semibold mb-4 text-center">30-Day Bonus Calendar</h2>
      <div class="grid grid-cols-3 sm:grid-cols-5 gap-3 sm:gap-4" id="daysGrid">
        <!-- Days will be generated by JavaScript -->
      </div>
    </div>

    <!-- Next Claim Timer -->
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-4 sm:p-6 text-center">
      <h3 class="text-gray-700 text-base sm:text-lg font-semibold mb-2">Next Bonus Available In</h3>
      <div class="text-2xl sm:text-3xl font-bold text-orange-600" id="countdown">--:--:--</div>
      <p class="text-xs sm:text-sm text-gray-600 mt-2">Come back tomorrow for your next reward!</p>
    </div>

    <!-- Bonus Rules -->
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-blue-800 mb-3">How Daily Bonus Works</h3>
      <ul class="space-y-2 text-sm sm:text-base text-gray-700">
        <li class="flex items-start gap-2">
          <span class="text-green-600 font-bold">✓</span>
          <span>Claim your daily bonus once every 24 hours</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-green-600 font-bold">✓</span>
          <span>Rewards increase over 30 days (Day 1: 1 FT → Day 30: 7 FT)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-green-600 font-bold">✓</span>
          <span>Miss a day and your streak resets to Day 1</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-green-600 font-bold">✓</span>
          <span>Complete 30-day streak for bonus multiplier on next cycle</span>
        </li>
      </ul>
    </div>
  </section>

  <!-- Bottom Ad -->
  <div class="bottom-ad">
    <script type="text/javascript">
      atOptions = {
        'key': '63718988f07bc6d276f3c6a441757cae',
        'format': 'iframe',
        'height': 90,
        'width': 728,
        'params': {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/63718988f07bc6d276f3c6a441757cae/invoke.js"></script>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAH9-GEeIVDe98wCziPHnDv5Q84BoQFXOQ",
      authDomain: "farmtoken.firebaseapp.com",
      databaseURL: "https://farmtoken-default-rtdb.firebaseio.com",
      projectId: "farmtoken",
      storageBucket: "farmtoken.firebasestorage.app",
      messagingSenderId: "873508490805",
      appId: "1:873508490805:web:6d2676c41aa60a289cab7c",
      measurementId: "G-YZPTK2CP47"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let userData = null;

    const dailyRewards = [
      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // Days 1-10: 10 tokens
      2, 2, 2, 2, 2, // Days 11-15: 10 tokens
      3, 3, 3, 3, 3, // Days 16-20: 15 tokens
      4, 4, 4, 4, 4, // Days 21-25: 20 tokens
      5, 5, 5, 5, 7  // Days 26-30: 27 tokens
    ]; // Total: 10 + 10 + 15 + 20 + 27 = 100 tokens

    const el = {
      loading: document.getElementById('loading'),
      notification: document.getElementById('notification'),
      streakCount: document.getElementById('streakCount'),
      totalEarned: document.getElementById('totalEarned'),
      daysGrid: document.getElementById('daysGrid'),
      countdown: document.getElementById('countdown'),
      adModal: document.getElementById('adModal')
    };

    function showNotification(message, isError = false) {
      el.notification.textContent = message;
      el.notification.classList.toggle('error', isError);
      el.notification.classList.add('show');
      setTimeout(() => {
        el.notification.classList.remove('show');
      }, 3000);
    }

    function showAdModal() {
      el.adModal.style.display = 'flex';
      setTimeout(() => {
        closeAdModal();
      }, 5000); // Auto-close after 5 seconds
    }

    window.closeAdModal = function() {
      el.adModal.style.display = 'none';
    };

    function renderDays() {
      const currentDay = userData.dailyBonus?.currentDay || 0;
      const lastClaim = userData.dailyBonus?.lastClaim || 0;
      const now = Date.now();
      const oneDayMs = 24 * 60 * 60 * 1000;
      const canClaim = now - lastClaim >= oneDayMs;

      el.daysGrid.innerHTML = '';

      for (let i = 0; i < 30; i++) {
        const dayNum = i + 1;
        const reward = dailyRewards[i];
        const isClaimed = dayNum < currentDay || (dayNum === currentDay && !canClaim);
        const isCurrent = dayNum === currentDay && canClaim;

        const card = document.createElement('div');
        card.className = `day-card bg-white rounded-xl p-4 text-center relative ${isClaimed ? 'claimed' : ''} ${isCurrent ? 'current' : ''}`;
        
        if (isCurrent) {
          card.innerHTML = `
            <div class="reward-badge">Claim Now!</div>
            <div class="text-2xl font-bold text-green-600 mb-2">Day ${dayNum}</div>
            <div class="text-3xl font-bold text-yellow-600 mb-2">${reward} FT</div>
            <button class="claim-btn w-full py-2 text-white font-semibold rounded-lg" onclick="claimDaily(${dayNum})">
              Claim Reward
            </button>
          `;
        } else {
          card.innerHTML = `
            <div class="text-lg font-bold text-gray-700 mb-2">Day ${dayNum}</div>
            <div class="text-2xl font-bold ${isClaimed ? 'text-gray-400' : 'text-yellow-600'} mb-2">${reward} FT</div>
            ${isClaimed ? '<div class="checkmark">✓</div>' : '<div class="text-xs text-gray-500">Upcoming</div>'}
          `;
        }

        el.daysGrid.appendChild(card);
      }
    }

    async function claimDaily(day) {
      if (!currentUser || !userData) return;

      const now = Date.now();
      const lastClaim = userData.dailyBonus?.lastClaim || 0;
      const oneDayMs = 24 * 60 * 60 * 1000;

      if (now - lastClaim < oneDayMs) {
        showNotification('You already claimed today! Come back tomorrow.', true);
        return;
      }

      try {
        const reward = dailyRewards[day - 1];
        const newBalance = (userData.balance || 0) + reward;
        const newTotalEarned = (userData.dailyBonus?.totalEarned || 0) + reward;
        const nextDay = day === 30 ? 1 : day + 1;

        const updates = {
          balance: newBalance,
          'dailyBonus/currentDay': nextDay,
          'dailyBonus/lastClaim': now,
          'dailyBonus/totalEarned': newTotalEarned,
          'dailyBonus/streak': day === 30 ? (userData.dailyBonus?.streak || 0) + 1 : (userData.dailyBonus?.streak || 0)
        };

        await update(ref(db, `users/${currentUser.uid}`), updates);

        userData.balance = newBalance;
        userData.dailyBonus = {
          ...userData.dailyBonus,
          currentDay: nextDay,
          lastClaim: now,
          totalEarned: newTotalEarned,
          streak: day === 30 ? (userData.dailyBonus?.streak || 0) + 1 : (userData.dailyBonus?.streak || 0)
        };

        showNotification(`Successfully claimed ${reward} FT!`);
        showAdModal(); // Show ad after successful claim
        updateUI();
      } catch (error) {
        console.error('Error claiming bonus:', error);
        showNotification('Failed to claim bonus. Please try again.', true);
      }
    }

    function updateCountdown() {
      if (!userData?.dailyBonus?.lastClaim) {
        el.countdown.textContent = 'Available Now!';
        return;
      }

      const lastClaim = userData.dailyBonus.lastClaim;
      const nextClaim = lastClaim + (24 * 60 * 60 * 1000);
      const now = Date.now();
      const diff = nextClaim - now;

      if (diff <= 0) {
        el.countdown.textContent = 'Available Now!';
        return;
      }

      const hours = Math.floor(diff / (60 * 60 * 1000));
      const minutes = Math.floor((diff % (60 * 60 * 1000)) / (60 * 1000));
      const seconds = Math.floor((diff % (60 * 1000)) / 1000);

      el.countdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateUI() {
      const streak = userData.dailyBonus?.streak || 0;
      const totalEarned = userData.dailyBonus?.totalEarned || 0;

      el.streakCount.textContent = streak;
      el.totalEarned.textContent = totalEarned.toFixed(2) + ' FT';

      renderDays();
      updateCountdown();
    }

    async function loadUserData(user) {
      try {
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
          userData = snapshot.val();

          if (!userData.dailyBonus) {
            userData.dailyBonus = {
              currentDay: 1,
              lastClaim: 0,
              totalEarned: 0,
              streak: 0
            };
            await update(userRef, { dailyBonus: userData.dailyBonus });
          }

          const lastClaim = userData.dailyBonus.lastClaim || 0;
          const now = Date.now();
          const twoDaysMs = 48 * 60 * 60 * 1000;

          if (lastClaim && now - lastClaim >= twoDaysMs) {
            userData.dailyBonus.currentDay = 1;
            await update(userRef, { 'dailyBonus/currentDay': 1 });
          }

          updateUI();
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showNotification('Failed to load data. Please refresh.', true);
      }
    }

    window.claimDaily = claimDaily;

    onAuthStateChanged(auth, user => {
      el.loading.style.display = 'none';
      if (user) {
        currentUser = user;
        loadUserData(user);
        setInterval(updateCountdown, 1000);
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>