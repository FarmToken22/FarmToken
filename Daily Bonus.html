<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FarmToken - Claim Your Daily Bonus">
  <title>FarmToken - Daily Bonus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --accent: #f59e0b;
      --success: #10b981;
      --error: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
      color: #1f2937;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .loading {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      gap: 1.5rem;
    }

    .spinner {
      width: 3rem;
      height: 3rem;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      font-weight: 600;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--error), #dc2626);
    }

    .day-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1.5rem;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 12rem;
    }

    .day-card.claimed {
      background: linear-gradient(135deg, #86efac, #4ade80);
      color: white;
    }

    .day-card.current {
      background: linear-gradient(135deg, #fef3c7, #fde047);
      border: 3px solid var(--accent);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .day-number {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .reward-amount {
      font-size: 2.5rem;
      font-weight: 900;
      color: var(--accent);
      margin: 0.5rem 0;
    }

    .reward-label {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    .day-card.claimed .day-number,
    .day-card.claimed .reward-amount,
    .day-card.claimed .reward-label {
      color: white;
    }

    .claim-badge {
      position: absolute;
      top: -0.75rem;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--error), #dc2626);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: bounce 1.5s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-4px); }
    }

    .claim-btn {
      background: linear-gradient(135deg, var(--accent), #d97706);
      color: white;
      font-size: 1rem;
      font-weight: 700;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .claim-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    .claim-btn:disabled {
      background: linear-gradient(135deg, #9ca3af, #6b7280);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .ad-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .ad-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1.5rem;
      text-align: center;
      max-width: 24rem;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .close-ad {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s ease;
    }

    .close-ad:hover {
      color: #1f2937;
      transform: scale(1.1);
    }

    .timer {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }

    .timer span {
      font-weight: 800;
      color: var(--accent);
    }

    .ad-banner {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 728px;
      margin-left: auto;
      margin-right: auto;
    }

    .ad-banner iframe {
      display: block;
      margin: 0 auto;
      border: none;
    }

    .ad-fallback {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
    }

    @media (max-width: 768px) {
      .ad-banner {
        max-width: 100%;
      }
      .ad-banner iframe {
        width: 100% !important;
        max-width: 320px;
      }
    }

    @media (max-width: 640px) {
      .day-card {
        min-height: 10rem;
        padding: 1rem;
      }
      .reward-amount {
        font-size: 2rem;
      }
      .reward-label {
        font-size: 1rem;
      }
      .timer {
        font-size: 1rem;
        padding: 0.75rem;
      }
      .ad-banner {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p class="text-white text-lg font-semibold">Loading...</p>
  </div>

  <div id="notification" class="notification" role="alert"></div>

  <div id="adModal" class="ad-modal">
    <div class="ad-modal-content">
      <span class="close-ad" onclick="closeAdModal()" aria-label="Close modal">&times;</span>
      <div class="text-4xl mb-4">üéâ</div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Reward Claimed!</h3>
      <p class="text-gray-600 mb-4">Your daily bonus has been added!</p>
      <div id="claimAd">
        <!-- Optional ad in modal -->
      </div>
    </div>
  </div>

  <header class="header flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-2">
      <img src="Logo.png" alt="FarmToken Logo" class="h-12 w-12 rounded-full bg-white p-1 shadow-md" 
           onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%2310b981%22/></svg>'">
      <h1 class="text-2xl font-bold text-white">Daily Bonus</h1>
    </div>
    <a href="index.html" class="p-2 hover:bg-white/10 rounded-xl" aria-label="Back to home">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
    </a>
  </header>

  <main class="flex-1 p-4 max-w-6xl mx-auto w-full">
    <div id="adBanner" class="ad-banner" role="region" aria-label="Advertisement"></div>
    <div id="timer" class="timer" role="timer" aria-live="polite">Next claim in: <span id="countdown">00:00:00</span></div>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="daysGrid"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAH9-GEeIVDe98wCziPHnDv5Q84BoQFXOQ",
      authDomain: "farmtoken.firebaseapp.com",
      databaseURL: "https://farmtoken-default-rtdb.firebaseio.com",
      projectId: "farmtoken",
      storageBucket: "farmtoken.firebasestorage.app",
      messagingSenderId: "873508490805",
      appId: "1:873508490805:web:6d2676c41aa60a289cab7c",
      measurementId: "G-YZPTK2CP47"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const dailyRewards = [
      1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
      2, 2, 2, 2, 2,
      3, 3, 3, 3, 3,
      4, 4, 4, 4, 4,
      5, 5, 5, 5, 7
    ];

    const ads = [
      { 
        key: '63718988f07bc6d276f3c6a441757cae', 
        width: 728, 
        height: 90, 
        src: '//www.highperformanceformat.com/63718988f07bc6d276f3c6a441757cae/invoke.js',
        config: {
          key: '63718988f07bc6d276f3c6a441757cae',
          format: 'iframe',
          height: 90,
          width: 728,
          params: {}
        }
      },
      { 
        key: 'c620af328467e6de19dc04af696ee0fb', 
        width: 300, 
        height: 250, 
        src: '//www.highperformanceformat.com/c620af328467e6de19dc04af696ee0fb/invoke.js',
        config: {
          key: 'c620af328467e6de19dc04af696ee0fb',
          format: 'iframe',
          height: 250,
          width: 300,
          params: {}
        }
      },
      { 
        key: '78ade24182729fceea8e45203dad915b', 
        width: 320, 
        height: 50, 
        src: '//www.highperformanceformat.com/78ade24182729fceea8e45203dad915b/invoke.js',
        config: {
          key: '78ade24182729fceea8e45203dad915b',
          format: 'iframe',
          height: 50,
          width: 320,
          params: {}
        }
      }
    ];

    const elements = {
      loading: document.getElementById('loading'),
      notification: document.getElementById('notification'),
      daysGrid: document.getElementById('daysGrid'),
      adModal: document.getElementById('adModal'),
      countdown: document.getElementById('countdown'),
      adBanner: document.getElementById('adBanner')
    };

    let currentUser = null;
    let userData = null;
    let timerInterval = null;
    let adInterval = null;

    function showNotification(message, isError = false) {
      try {
        elements.notification.textContent = message;
        elements.notification.classList.toggle('error', isError);
        elements.notification.classList.add('show');
        setTimeout(() => elements.notification.classList.remove('show'), 3000);
      } catch (error) {
        console.error('Notification error:', error);
      }
    }

    function showAdModal() {
      try {
        elements.adModal.style.display = 'flex';
        setTimeout(closeAdModal, 5000);
      } catch (error) {
        console.error('Ad modal error:', error);
      }
    }

    window.closeAdModal = function() {
      try {
        elements.adModal.style.display = 'none';
      } catch (error) {
        console.error('Close ad modal error:', error);
      }
    };

    function loadAdScript(ad) {
      try {
        // Set atOptions for the specific ad
        window.atOptions = ad.config;

        // Create and append the ad script
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = `https:${ad.src}`;
        script.async = true;
        script.onerror = () => {
          console.error('Failed to load ad script:', ad.src);
          elements.adBanner.innerHTML = `<img src="https://via.placeholder.com/${ad.width}x${ad.height}?text=Ad+Failed" alt="Ad Fallback" class="ad-fallback">`;
        };
        elements.adBanner.innerHTML = ''; // Clear previous content
        elements.adBanner.appendChild(script);
      } catch (error) {
        console.error('Ad script load error:', error);
        elements.adBanner.innerHTML = `<img src="https://via.placeholder.com/${ad.width}x${ad.height}?text=Ad+Error" alt="Ad Fallback" class="ad-fallback">`;
      }
    }

    function rotateAd() {
      try {
        const randomAd = ads[Math.floor(Math.random() * ads.length)];
        loadAdScript(randomAd);
      } catch (error) {
        console.error('Ad rotation error:', error);
        elements.adBanner.innerHTML = `<img src="https://via.placeholder.com/320x50?text=Ad+Error" alt="Ad Fallback" class="ad-fallback">`;
      }
    }

    function startAdRotation() {
      try {
        if (adInterval) clearInterval(adInterval);
        rotateAd();
        adInterval = setInterval(rotateAd, 30000); // Rotate every 30 seconds
      } catch (error) {
        console.error('Ad rotation start error:', error);
      }
    }

    function formatTime(ms) {
      try {
        if (ms <= 0) return 'Ready to claim!';
        const hours = Math.floor(ms / (1000 * 60 * 60)).toString().padStart(2, '0');
        const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
        const seconds = Math.floor((ms % (1000 * 60)) / 1000).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      } catch (error) {
        console.error('Format time error:', error);
        return 'Error';
      }
    }

    function updateTimer(lastClaim) {
      try {
        if (timerInterval) clearInterval(timerInterval);
        
        const oneDayMs = 24 * 60 * 60 * 1000;
        const update = () => {
          const now = Date.now();
          const timeLeft = oneDayMs - (now - lastClaim);
          if (timeLeft <= 0) {
            elements.countdown.textContent = 'Ready to claim!';
            clearInterval(timerInterval);
            renderDays();
          } else {
            elements.countdown.textContent = formatTime(timeLeft);
          }
        };
        
        update();
        timerInterval = setInterval(update, 1000);
      } catch (error) {
        console.error('Update timer error:', error);
        elements.countdown.textContent = 'Error';
      }
    }

    function renderDays() {
      try {
        const currentDay = userData?.dailyBonus?.currentDay || 1;
        const lastClaim = userData?.dailyBonus?.lastClaim || 0;
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;
        const canClaim = now - lastClaim >= oneDayMs;

        updateTimer(lastClaim);
        startAdRotation();

        elements.daysGrid.innerHTML = '';

        dailyRewards.forEach((reward, index) => {
          const dayNum = index + 1;
          const isClaimed = dayNum < currentDay || (dayNum === currentDay && !canClaim);
          const isCurrent = dayNum === currentDay && canClaim;

          const card = document.createElement('div');
          card.className = `day-card ${isClaimed ? 'claimed' : ''} ${isCurrent ? 'current' : ''}`;
          card.setAttribute('role', 'region');
          card.setAttribute('aria-label', `Day ${dayNum} bonus`);

          card.innerHTML = `
            <div>
              <div class="day-number">Day ${dayNum}</div>
              <div class="reward-amount">${reward}</div>
              <div class="reward-label">FT</div>
            </div>
            ${isCurrent ? `
              <div class="claim-badge">Claim Now!</div>
              <button class="claim-btn" onclick="claimDaily(${dayNum})" aria-label="Claim day ${dayNum} bonus">
                <span>üéÅ</span> Claim
              </button>
            ` : `
              <div class="status-label">
                ${isClaimed ? '<div class="checkmark" aria-hidden="true">‚úì</div>' : 'Upcoming'}
              </div>
            `}
          `;

          elements.daysGrid.appendChild(card);
        });
      } catch (error) {
        console.error('Render days error:', error);
        showNotification('‚ùå Failed to render rewards. Please refresh.', true);
      }
    }

    async function claimDaily(day) {
      try {
        if (!currentUser || !userData) {
          showNotification('Please log in to claim rewards.', true);
          return;
        }

        const now = Date.now();
        const lastClaim = userData.dailyBonus?.lastClaim || 0;
        const oneDayMs = 24 * 60 * 60 * 1000;

        if (now - lastClaim < oneDayMs) {
          showNotification('‚è∞ Already claimed today! Try again tomorrow.', true);
          return;
        }

        const reward = dailyRewards[day - 1];
        const newBalance = (userData.balance || 0) + reward;
        const newTotalEarned = (userData.dailyBonus?.totalEarned || 0) + reward;
        const nextDay = day === 30 ? 1 : day + 1;

        const updates = {
          balance: newBalance,
          'dailyBonus/currentDay': nextDay,
          'dailyBonus/lastClaim': now,
          'dailyBonus/totalEarned': newTotalEarned,
          'dailyBonus/streak': day === 30 ? (userData.dailyBonus?.streak || 0) + 1 : (userData.dailyBonus?.streak || 0)
        };

        await update(ref(db, `users/${currentUser.uid}`), updates);

        userData = {
          ...userData,
          balance: newBalance,
          dailyBonus: {
            ...userData.dailyBonus,
            currentDay: nextDay,
            lastClaim: now,
            totalEarned: newTotalEarned,
            streak: day === 30 ? (userData.dailyBonus?.streak || 0) + 1 : (userData.dailyBonus?.streak || 0)
          }
        };

        showNotification(`üéâ Claimed ${reward} FT!`);
        showAdModal();
        renderDays();
      } catch (error) {
        console.error('Claim error:', error);
        showNotification('‚ùå Failed to claim reward. Try again.', true);
      }
    }

    async function loadUserData(user) {
      try {
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
          userData = snapshot.val();

          if (!userData.dailyBonus) {
            userData.dailyBonus = {
              currentDay: 1,
              lastClaim: 0,
              totalEarned: 0,
              streak: 0
            };
            await update(userRef, { dailyBonus: userData.dailyBonus });
          }

          const lastClaim = userData.dailyBonus.lastClaim || 0;
          const now = Date.now();
          const twoDaysMs = 48 * 60 * 60 * 1000;

          if (lastClaim && now - lastClaim >= twoDaysMs) {
            userData.dailyBonus.currentDay = 1;
            await update(userRef, { 'dailyBonus/currentDay': 1 });
          }

          renderDays();
        } else {
          showNotification('No user data found.', true);
        }
      } catch (error) {
        console.error('Load user data error:', error);
        showNotification('‚ùå Failed to load data. Please refresh.', true);
      }
    }

    // Handle obfuscated ad script
    function runObfuscatedAdScript() {
      try {
        // Simulate simplified obfuscated script logic (browser fingerprinting and ad tracking)
        (function() {
          var lW = window, lI = navigator, lC = document;
          var ld = [], lm = [], lP = lC.getElementsByTagName('script');
          var lc = 0xe, lz = 0x0, lo = 0x0;

          var le = {
            isEmulate: function() {
              return /SmartTV/.test(lI.userAgent) ? false : /mobile|android|iphone|ipad/i.test(lI.userAgent);
            },
            addTest: function(name, truePoints, falsePoints, fn) {
              ld.push({ name, truePoints, falsePoints, fn });
            },
            runTests: function() {
              ld.forEach(function(test, index) {
                try {
                  var result = typeof test.fn === 'function' ? test.fn() : false;
                  if (result) lz |= 1 << index;
                  lm.push({ name: test.name, result });
                } catch (e) {
                  lo |= 1 << index;
                }
              });
              return this;
            },
            getResults: function() {
              return lc + '.' + lz + (lo > 0 ? '.' + lo : '');
            }
          };

          le.addTest('hasTouchEvents', { m: 0x5 }, { d: 0x5 }, function() {
            return 'ontouchstart' in lW || lI.maxTouchPoints > 0;
          });

          le.runTests();
          var psid = le.getResults();
          console.log('Ad script PSID:', psid);

          // Simulate ad network call
          var xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://wayfarerorthodox.com/watch.js?psid=' + encodeURIComponent(psid), true);
          xhr.send();
        })();
      } catch (error) {
        console.error('Obfuscated ad script error:', error);
        showNotification('‚ùå Ad script failed to load.', true);
      }
    }

    window.claimDaily = claimDaily;

    // Initialize after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      try {
        startAdRotation();
        runObfuscatedAdScript();
      } catch (error) {
        console.error('Initialization error:', error);
      }
    });

    try {
      onAuthStateChanged(auth, user => {
        elements.loading.style.display = 'none';
        if (user) {
          currentUser = user;
          loadUserData(user);
        } else {
          window.location.href = 'login.html';
        }
      });
    } catch (error) {
      console.error('Auth state change error:', error);
      showNotification('‚ùå Authentication error. Please refresh.', true);
    }
  </script>
</body>
</html>