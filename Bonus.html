<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="FarmZone - Bonus Page">
  <title>FarmZone - Bonus</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow-x: hidden;
      padding-bottom: 80px;
      min-height: 100vh;
      background: #f9fafb;
      transition: background 0.3s ease;
    }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }

    .section { display: none; animation: fadeIn 0.4s ease; }
    .section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #28a745;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .bonus-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    .bonus-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      max-width: 90%;
      width: 320px;
    }
    .modal-overlay.visible .modal-content {
      transform: scale(1);
    }

    .progress-bar {
      width: 100%;
      background-color: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
      height: 12px;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 8px;
      transition: width 0.1s linear;
    }

    .nav-btn {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 10px 0;
      flex: 1;
    }
    .nav-btn.active { color: #28a745; }

    .nav-indicator {
      position: absolute;
      top: 0;
      height: 3px;
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 0 0 3px 3px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
    }

    .task-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .toast {
      padding: 12px 16px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.4s ease forwards, fadeOut 0.4s ease 2.6s forwards;
      opacity: 0;
      transform: translateX(100%);
    }
    .toast-success { background: #28a745; }
    .toast-error { background: #ef4444; }
    .toast-info { background: #3b82f6; }

    @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }

    .ad-viewer {
      min-height: 90px;
      background: #f8fafc;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 8px;
    }
    .filter-tabs::-webkit-scrollbar { height: 0; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <div id="toastContainer" class="toast-container"></div>

  <header class="flex items-center justify-between px-4 py-3 shadow bg-white sticky top-0 z-40 border-b border-gray-200">
    <a href="index.html" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-all">
      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
    </a>
    <h1 class="text-xl font-bold text-green-600">Rewards & History</h1>
    <div class="bg-green-50 text-green-700 px-3 py-1.5 rounded-lg font-bold text-sm flex items-center gap-1 border border-green-200">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/></svg>
      <span id="balanceAmount">0.00</span> FZ
    </div>
  </header>

  <main class="flex-grow">
    <!-- Daily Bonus Section -->
    <section id="dailySection" class="section active p-4 max-w-md mx-auto w-full">
      <div id="dailyLoading" class="text-center py-10">
        <div class="spinner mb-3"></div>
        <p class="text-gray-600">Loading rewards...</p>
      </div>
      <div id="dailyContent" style="display: none;">
        <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Daily Bonus</h2>
        <div class="grid grid-cols-3 gap-3 sm:gap-4" id="bonusGrid"></div>
      </div>
    </section>

    <!-- History Section -->
    <section id="historySection" class="section p-4 max-w-2xl mx-auto w-full">
      <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Transaction History</h2>
      <div class="filter-tabs flex gap-2 mb-4 overflow-x-auto bg-white p-2 rounded-xl shadow-sm">
        <button class="filter-tab px-3 py-2 whitespace-nowrap rounded-lg text-sm font-medium cursor-pointer flex-shrink-0 bg-green-500 text-white" data-filter="all">All</button>
        <button class="filter-tab px-3 py-2 whitespace-nowrap rounded-lg text-sm font-medium cursor-pointer flex-shrink-0 bg-gray-100 text-gray-600" data-filter="daily_bonus">Daily Bonus</button>
        <button class="filter-tab px-3 py-2 whitespace-nowrap rounded-lg text-sm font-medium cursor-pointer flex-shrink-0 bg-gray-100 text-gray-600" data-filter="mining">Mining</button>
        <button class="filter-tab px-3 py-2 whitespace-nowrap rounded-lg text-sm font-medium cursor-pointer flex-shrink-0 bg-gray-100 text-gray-600" data-filter="referral">Referral</button>
      </div>
      <div id="transactionsList" class="space-y-3"></div>
      <div id="emptyState" class="text-center py-16 bg-white rounded-xl" style="display: none;">
        <div class="text-6xl mb-4 opacity-20">ðŸ“‹</div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">No Activity Yet</h3>
        <p class="text-sm text-gray-500">Start earning to see your history.</p>
      </div>
    </section>
  </main>

  <!-- Reward Modal -->
  <div id="rewardedAdModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-xl font-bold text-gray-800 mb-2">Claim Daily Bonus!</h3>
      <p class="text-gray-600 mb-6">Watch a short ad to receive your reward.</p>
      <div class="flex justify-center gap-3">
        <button id="cancelAdBtn" class="flex-1 px-5 py-2.5 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200">Cancel</button>
        <button id="watchAdBtn" class="flex-1 px-5 py-2.5 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600">Watch Ad</button>
      </div>
    </div>
  </div>

  <!-- Ad Player Modal -->
  <div id="adPlayerModal" class="modal-overlay">
    <div class="modal-content">
      <p class="text-gray-700 font-semibold mb-3">Ad is playing...</p>
      <div class="progress-bar">
        <div id="adProgressBar" class="progress-bar-inner"></div>
      </div>
      <p id="adCountdownText" class="text-sm text-gray-500 mt-2">Watch for 8s...</p>
      <div id="rewardedAdContent" class="ad-viewer mt-4"></div>
    </div>
  </div>

  <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t border-gray-200 z-30">
    <div class="relative max-w-lg mx-auto">
      <div class="nav-indicator" id="navIndicator"></div>
      <div class="flex justify-around">
        <button data-section="daily" class="nav-btn active">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <span class="text-xs">Bonus</span>
        </button>
        <button data-section="history" class="nav-btn">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
          <span class="text-xs">History</span>
        </button>
      </div>
    </div>
  </footer>

  <script type="module">
    import { auth, database } from './config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { ref, get, update, runTransaction, onValue, push, off } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // --- Ad System (Unchanged) ---
    const AD_CONFIG = { rewarded: { key: '53c6462d2fd5ad5b91686ca9561f79a2', format: 'iframe', height: 90, width: 728, invokeUrl: '//www.highperformanceformat.com/53c6462d2fd5ad5b91686ca9561f79a2/invoke.js'}};
    function loadRewardedAd(containerId, callback) {
        const container = document.getElementById(containerId);
        if (!container) return callback(false);
        container.innerHTML = '<div class="spinner" style="width:32px;height:32px;border-width:3px;"></div><p class="text-sm text-gray-500">Loading ad...</p>';
        const adLoadTimeout = setTimeout(() => { container.innerHTML = '<p class="text-sm text-red-500">Ad failed to load.</p>'; callback(false); }, 8000);
        try {
            window.atOptions = AD_CONFIG.rewarded;
            const script = document.createElement('script');
            script.type = 'text/javascript'; script.src = AD_CONFIG.rewarded.invokeUrl; script.async = true;
            script.onload = () => { clearTimeout(adLoadTimeout); callback(true); };
            script.onerror = () => { clearTimeout(adLoadTimeout); container.innerHTML = '<p class="text-sm text-red-500">Ad failed to load.</p>'; callback(false); };
            container.appendChild(script);
        } catch (error) { clearTimeout(adLoadTimeout); container.innerHTML = '<p class="text-sm text-red-500">An error occurred.</p>'; callback(false); }
    }
    // --- End Ad System ---

    const dailyRewards = [1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,7];
    let userData = null;
    let userId = null;
    let adCountdownInterval = null;
    let allTransactions = [];
    let currentFilter = 'all';
    let userRef = null;
    let userListener = null;

    const elements = {
      balanceEl: document.getElementById('balanceAmount'),
      toastContainer: document.getElementById('toastContainer'),
      dailyLoading: document.getElementById('dailyLoading'),
      dailyContent: document.getElementById('dailyContent'),
      transactionsList: document.getElementById('transactionsList'),
      emptyState: document.getElementById('emptyState'),
      bonusGrid: document.getElementById('bonusGrid'),
      adModal: document.getElementById('rewardedAdModal'),
      adPlayerModal: document.getElementById('adPlayerModal'),
      watchAdBtn: document.getElementById('watchAdBtn'),
      cancelAdBtn: document.getElementById('cancelAdBtn')
    };

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      elements.toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), duration + 300);
    }

    function getUnixDay(ts) { return Math.floor(ts / (1000 * 60 * 60 * 24)); }

    function setupNavigation() {
        const navContainer = document.querySelector('footer .flex');
        const navIndicator = document.getElementById('navIndicator');

        const updateIndicator = (btn) => {
            const btnRect = btn.getBoundingClientRect();
            const parentRect = navContainer.getBoundingClientRect();
            navIndicator.style.width = `${btnRect.width}px`;
            navIndicator.style.left = `${btnRect.left - parentRect.left}px`;
        };

        navContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.nav-btn');
            if (!button) return;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const section = button.dataset.section;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${section}Section`).classList.add('active');
            updateIndicator(button);
        });
        
        const initialActiveBtn = document.querySelector('.nav-btn.active');
        if (initialActiveBtn) setTimeout(() => updateIndicator(initialActiveBtn), 100);
        window.addEventListener('resize', () => updateIndicator(document.querySelector('.nav-btn.active')));
    }

    function renderDailyGrid() {
        if (!userData) return;
        elements.bonusGrid.innerHTML = '';
        const currentStreak = userData.currentStreak || 0;
        const lastClaimTime = userData.lastClaimTime || 0;
        const currentDay = getUnixDay(Date.now());
        const lastClaimDay = getUnixDay(lastClaimTime);

        dailyRewards.forEach((reward, i) => {
            const card = document.createElement("div");
            card.className = "bonus-card";
            card.innerHTML = `<h3 class="font-semibold text-gray-700">Day ${i + 1}</h3><p class="text-sm text-gray-500 mb-3">+${reward} FZ</p><button class="w-full py-2 rounded-lg text-sm font-semibold transition-all"></button>`;
            const btn = card.querySelector('button');
            if (i < currentStreak) { btn.textContent = "Claimed"; btn.className += " bg-green-100 text-green-700"; btn.disabled = true; } 
            else if (i > currentStreak) { btn.textContent = "Locked"; btn.className += " bg-gray-100 text-gray-400"; btn.disabled = true; } 
            else {
                if (currentDay > lastClaimDay) { btn.textContent = "Claim Now"; btn.className += " bg-green-500 text-white hover:bg-green-600"; btn.onclick = () => elements.adModal.classList.add('visible'); } 
                else { btn.textContent = "Come Back"; btn.className += " bg-gray-200 text-gray-600"; btn.disabled = true; }
            }
            elements.bonusGrid.appendChild(card);
        });
        elements.dailyLoading.style.display = 'none';
        elements.dailyContent.style.display = 'block';
    }
    
    function startAdSequence() {
        elements.adModal.classList.remove('visible');
        elements.adPlayerModal.classList.add('visible');
        const countText = document.getElementById('adCountdownText');
        const progressBar = document.getElementById('adProgressBar');
        progressBar.style.width = '0%';
        countText.textContent = 'Loading ad...';

        loadRewardedAd('rewardedAdContent', (success) => {
            if (!success) {
                showToast('Ad failed, claiming bonus directly.', 'info');
                setTimeout(() => { elements.adPlayerModal.classList.remove('visible'); claimDailyBonus(); }, 1500);
                return;
            }
            let count = 8;
            countText.textContent = `Watch for ${count}s...`;
            if(adCountdownInterval) clearInterval(adCountdownInterval);
            adCountdownInterval = setInterval(() => {
                count--;
                countText.textContent = `Watch for ${count}s...`;
                progressBar.style.width = `${((8 - count) / 8) * 100}%`;
                if (count <= 0) { clearInterval(adCountdownInterval); elements.adPlayerModal.classList.remove('visible'); claimDailyBonus(); }
            }, 1000);
        });
    }

    async function claimDailyBonus() {
        if (!userId) return showToast('Authentication required.', 'error');
        if (!userRef) userRef = ref(database, 'users/' + userId);
        try {
            const result = await runTransaction(userRef, (currentData) => {
                if (!currentData) return;
                const currTs = Date.now();
                const currDay = getUnixDay(currTs);
                const lastDay = getUnixDay(currentData.lastClaimTime || 0);
                if (currDay <= lastDay) return;
                let streak = currentData.currentStreak || 0;
                if (currDay > lastDay + 1) streak = 0;
                const reward = dailyRewards[streak] || 0;
                if (!currentData.balance) currentData.balance = 0;
                currentData.balance += reward;
                currentData.currentStreak = streak + 1;
                currentData.lastClaimTime = currTs;
                return currentData;
            });
            if (result.committed) {
                const newUserData = result.snapshot.val();
                const rewardAmount = newUserData.balance - (userData.balance || 0);
                const transactionRef = ref(database, `users/${userId}/transactions`);
                await push(transactionRef, { type: 'daily_bonus', amount: rewardAmount, timestamp: Date.now(), day: newUserData.currentStreak });
                showToast(`+${rewardAmount.toFixed(2)} FZ claimed!`, 'success');
            } else { showToast('Already claimed today.', 'info'); }
        } catch (err) { console.error('Claim error:', err); showToast('Failed to claim reward.', 'error'); }
    }
    
    // --- âœ… UPDATED HISTORY LOGIC ---
    function getTransactionTitle(type) {
        switch(type) {
            case 'daily_bonus': return 'Daily Bonus';
            case 'mining': return 'Mining Reward';
            case 'referral': return 'Referral Bonus';
            default: return 'Transaction';
        }
    }
    
    function renderHistory() {
        const filtered = currentFilter === 'all' ? allTransactions : allTransactions.filter(t => t.type === currentFilter);
        elements.transactionsList.innerHTML = '';

        if (filtered.length === 0) { elements.emptyState.style.display = 'block'; return; }
        elements.emptyState.style.display = 'none';

        filtered.forEach(trans => {
            const card = document.createElement('div');
            card.className = 'task-card flex justify-between items-center';
            card.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${getTransactionTitle(trans.type)}</p>
                    <p class="text-sm text-gray-500">${new Date(trans.timestamp).toLocaleString()}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-green-600">+${(trans.amount || 0).toFixed(2)} FZ</p>
                    ${trans.day ? `<p class="text-xs text-gray-500">Day ${trans.day}</p>` : ''}
                </div>
            `;
            elements.transactionsList.appendChild(card);
        });
    }
    
    function setupEventListeners() {
        elements.watchAdBtn.onclick = startAdSequence;
        elements.cancelAdBtn.onclick = () => elements.adModal.classList.remove('visible');
        
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => {
                    t.classList.remove('bg-green-500', 'text-white');
                    t.classList.add('bg-gray-100', 'text-gray-600');
                });
                tab.classList.add('bg-green-500', 'text-white');
                tab.classList.remove('bg-gray-100', 'text-gray-600');
                currentFilter = tab.dataset.filter;
                renderHistory();
            });
        });
    }

    onAuthStateChanged(auth, (user) => {
        if (userListener && userRef) off(userRef, 'value', userListener);
        if (user) {
            userId = user.uid;
            userRef = ref(database, 'users/' + userId);
            userListener = onValue(userRef, (snap) => {
                if (!snap.exists()) return;
                const oldStreak = userData ? (userData.currentStreak || 0) : 0;
                userData = snap.val();
                
                if (userData.balance === undefined) userData.balance = 0;
                if (userData.currentStreak === undefined) userData.currentStreak = 0;
                if (userData.lastClaimTime === undefined) userData.lastClaimTime = 0;
                
                const currentDay = getUnixDay(Date.now());
                const lastClaimDay = getUnixDay(userData.lastClaimTime);

                if (currentDay > lastClaimDay + 1 && userData.currentStreak > 0) {
                    update(userRef, { currentStreak: 0 }).then(() => {
                        if(oldStreak > 0) showToast('Your streak has been reset!', 'info');
                    });
                } else {
                    if (elements.balanceEl) elements.balanceEl.textContent = userData.balance.toFixed(2);
                    renderDailyGrid();
                }

                allTransactions = [];
                if (snap.hasChild('transactions')) {
                    snap.child('transactions').forEach(child => {
                        allTransactions.push({ id: child.key, ...child.val() });
                    });
                    allTransactions.sort((a, b) => b.timestamp - a.timestamp);
                }
                renderHistory();
            }, (error) => { console.error("Firebase error:", error); showToast("Could not sync data.", "error"); });
        } else {
            showToast('Please log in to access bonuses.', 'info');
            elements.dailyLoading.innerHTML = '<p class="text-gray-600">Please log in.</p>';
        }
    });

    setupNavigation();
    setupEventListeners();
  </script>
</body>
</html>